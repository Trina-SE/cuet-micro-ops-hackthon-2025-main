name: delineate

services:
  delineate-app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.prod
    ports:
      - "3000:3000"
    env_file:
      - ../.env
    environment:
      - NODE_ENV=production
    depends_on:
      delineate-storage:
        condition: service_started
      delineate-storage-setup:
        condition: service_completed_successfully
    restart: unless-stopped

  delineate-storage:
    image: rustfs/rustfs:latest
    environment:
      RUSTFS_VOLUMES: /data/rustfs{0...3}
      RUSTFS_ADDRESS: 0.0.0.0:9000
      RUSTFS_CONSOLE_ADDRESS: 0.0.0.0:9001
      RUSTFS_CONSOLE_ENABLE: "true"
      RUSTFS_EXTERNAL_ADDRESS: :9000
      RUSTFS_CORS_ALLOWED_ORIGINS: "*"
      RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS: "*"
      RUSTFS_ACCESS_KEY: ${S3_ACCESS_KEY_ID:-rustfsadmin}
      RUSTFS_SECRET_KEY: ${S3_SECRET_ACCESS_KEY:-rustfsadmin}
      RUSTFS_OBS_LOGGER_LEVEL: info
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - delineate-storage-data:/data
      - delineate-storage-logs:/app/logs
    depends_on:
      delineate-storage-perms:
        condition: service_completed_successfully

  delineate-storage-perms:
    image: alpine:3.20
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -e
        mkdir -p /data/rustfs0 /data/rustfs1 /data/rustfs2 /data/rustfs3
        chown -R 10001:10001 /data /logs
    volumes:
      - delineate-storage-data:/data
      - delineate-storage-logs:/logs
    restart: "no"

  delineate-storage-setup:
    image: minio/mc:latest
    depends_on:
      delineate-storage:
        condition: service_started
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY_ID:-rustfsadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_ACCESS_KEY:-rustfsadmin}
    entrypoint:
      - /bin/sh
      - -c
      - |
        set -e
        until mc alias set delineate http://delineate-storage:9000 "$${MINIO_ROOT_USER}" "$${MINIO_ROOT_PASSWORD}"; do
          sleep 2
        done
        mc mb -p delineate/downloads || true
    restart: "no"

  delineate-frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: http://localhost:3000
        VITE_SENTRY_DSN: ${SENTRY_DSN:-}
        VITE_OTEL_EXPORTER_URL: http://localhost:4318/v1/traces
        VITE_JAEGER_UI_URL: http://localhost:16686
    ports:
      - "4173:4173"
    depends_on:
      delineate-app:
        condition: service_started
    restart: unless-stopped

  delineate-node-exporter:
    image: prom/node-exporter:latest
    command:
      - "--path.rootfs=/host"
    volumes:
      - /:/host:ro
    ports:
      - "9100:9100"
    restart: unless-stopped

  delineate-prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    restart: unless-stopped
    depends_on:
      delineate-node-exporter:
        condition: service_started

  delineate-grafana:
    image: grafana/grafana:10.4.2
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3001:3000"
    volumes:
      - delineate-grafana-data:/var/lib/grafana
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./observability/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      delineate-prometheus:
        condition: service_started
    restart: unless-stopped

volumes:
  delineate-storage-data:
  delineate-storage-logs:
  delineate-grafana-data:
